# 钢铝混合车身焊接工序协同优化建模与分层强化学习策略

本文档面向钢铝混合白车身焊接线的多目标协同优化问题，给出形式化数学模型（可视为混合非线性动态规划问题），并提出分层强化学习（HRL）求解策略。模型覆盖工序分序（工位/夹具/焊点分配与先后顺序）和工步参数（焊接设备温度、功率、速度/路径等）的联合优化，目标兼顾节拍平衡、成本最低与精度最高。

## 1. 问题定义

- **对象**：一条包含 $S$ 个工位的自动化焊接线，焊接对象为钢铝混合白车身。焊点集合记为 $\mathcal{P}$，其中包含定位点与结构焊点；焊接/定位必须满足夹具约束与装配精度约束。
- **决策变量**：
  - **分序与分配**：
    - 工位启用与工位到工位的顺序：$x_{s}$（是否启用）、$\pi$（工位执行顺序）。
    - 焊点到工位/夹具的分配：$a_{p,s}\in\{0,1\}$，焊点 $p$ 是否由工位 $s$ 完成；$\sum_s a_{p,s}=1$。
    - 工位内路径与焊点排序：$o_{p,s}$ 表示在工位 $s$ 内的执行顺序（可视为工位内 TSP 子问题）。
  - **工步参数**：连续/离散混合变量，如温度 $T_{p,s}$、功率 $P_{p,s}$、焊枪速度 $v_{p,s}$、路径规划参数 $r_{p,s}$（例如关键路径偏移/姿态）。
  - **资源状态**：夹具更换/姿态 $f_{s}$、机器人可达性模式 $m_{s}$、设备模式切换时间 $\tau_{s}$。

- **目标**（多目标）：
  1. **节拍平衡**：最小化瓶颈工位节拍 $\max_s C_s$，其中 $C_s$ 为工位 $s$ 的循环时间。
  2. **成本**：设备能耗 + 夹具/电极损耗 + 设备切换成本，记为 $\text{Cost}(\cdot)$。
  3. **精度**：装配偏差（焊后几何精度）与焊接质量缺陷率，记为 $\text{Err}(\cdot)$。

可采用加权求和或 $\epsilon$-约束构建总体目标：
$$
\min_{x,a,o,T,P,v,r} \; \lambda_1 \max_s C_s + \lambda_2 \text{Cost}(\cdot) + \lambda_3 \text{Err}(\cdot)
$$
其中 $\lambda_i>0$ 可随训练自适应调整（或使用帕累托前沿搜索）。

## 2. 约束与子模型

1. **分配与覆盖约束**：$\sum_s a_{p,s}=1$；若工位 $s$ 不具备对应夹具/机器人可达性，则 $a_{p,s}=0$。
2. **序约束**：关键定位点需先于结构焊点；车身装配骨架形成后才能激活特定铝/钢拼接焊点。可用前驱集 $\text{pred}(p)$：若 $q\in\text{pred}(p)$，则 $o_{q,s}<o_{p,s}$ 或前序工位完成。
3. **工位循环时间**：
$$
C_s = t^{\text{load}}_s + t^{\text{unload}}_s + \sum_{p\in\mathcal{P}} a_{p,s}\big( t^{\text{move}}_{p,s}(o_{p,s},r_{p,s}) + t^{\text{weld}}_{p,s}(T_{p,s},P_{p,s},v_{p,s}) \big) + t^{\text{change}}_s(f_s,m_s)
$$
4. **设备与工艺窗口**：$T_{p,s}\in[T^{\min}_p, T^{\max}_p]$，$P_{p,s}\in[P^{\min}_p,P^{\max}_p]$，$v_{p,s}\in[v^{\min},v^{\max}]$；铝/钢异种材料需遵守热输入上限 $H_{p,s}=\kappa P_{p,s}/v_{p,s} \le H^{\max}_{p}$。
5. **几何精度传播模型**：焊接热输入引起的变形叠加，形成装配偏差：
$$
\Delta g = \sum_{p,s} a_{p,s}\, \phi_p(T_{p,s},P_{p,s},v_{p,s},r_{p,s}) + G(f_s,m_s)
$$
要求 $\|\Delta g\|_2 \le g^{\max}$；$\phi_p(\cdot)$ 可用经验代理模型或有限元降阶模型近似。
6. **稳定性/可行性**：焊点分配必须保证每个阶段的结构刚度满足 $K_k \succeq K^{\min}$（可定义阶段 $k$ 为工位或关键时间片）。

## 3. 混合非线性动态规划形式

可把工序分序视为高层离散决策，工步参数为低层连续控制。定义状态 $s_t = (\text{已完成焊点集合},\text{车身变形状态},\text{设备模式})$，决策 $u_t=(a_{p,s},o_{p,s},T_{p,s},P_{p,s},v_{p,s},r_{p,s},f_s,m_s)$，系统动态：
$$
 s_{t+1} = f(s_t, u_t) \quad \text{subject to constraints above}
$$
优化问题：
$$
\min_{\{u_t\}_{t=0}^{T-1}} \sum_{t} L(s_t,u_t) \quad \text{s.t. } s_{t+1}=f(s_t,u_t),\; g(s_t,u_t)\le 0
$$
其中 $L$ 集成节拍、成本、精度加权。约束 $g$ 包含工艺窗口、几何精度、刚度与工位容量等。该问题是混合非线性（离散分序 + 连续参数）并带有复杂约束，可采用混合整数非线性规划 (MINLP) 近似或动态规划/强化学习求解。

## 4. 分层强化学习（HRL）求解思路

### 4.1 层次结构

- **高层策略（规划层）**：输出工位启用、焊点到工位分配、工位内顺序初稿。可建模为策略 $\pi_H(\cdot)$，动作包含：
  - 选择下一工位及其待焊点集合；
  - 针对工位生成局部路径排序（可结合神经组合优化或强化学习版 TSP）
  - 资源模式（夹具/机器人模式）选择。
- **低层策略（控制层）**：在给定工位与焊点顺序的前提下，输出连续工艺参数 $(T,P,v,r)$ 与路径细化；策略 $\pi_L(\cdot)$ 可使用连续动作算法（DDPG/Twin-Delayed DDPG、SAC）或分布式多智能体（多机器人/焊枪协同）。
- **中间协同模块（可选）**：采用模仿学习或代理优化器对高层方案的可制造性进行快速评估，形成约束条件或 shaping 奖励。

### 4.2 状态、动作、奖励设计

- **状态特征**：
  - 已完成焊点/剩余焊点掩码、材料类型（钢/铝）、前驱约束图；
  - 工位资源状态（夹具姿态、机器人可达性模式、设备温度/功率上限）；
  - 当前阶段几何偏差估计 $\hat{\Delta g}$ 与刚度估计 $\hat{K}$；
  - 节拍信息（已用时间、工位等待时间）。
- **高层动作**：选择工位、分配子集、生成排序；可用 pointer network + 强化学习或图神经网络 (GNN) 对焊点图进行决策。
- **低层动作**：焊接参数连续值、微路径偏移、姿态/速度；
- **奖励**：
  - 高层：对瓶颈节拍、总能耗、几何误差超限惩罚，采用负值 reward；
  - 低层：工艺窗口违约惩罚、热输入超限惩罚、几何偏差代理损失、能耗损失；
  - 可采用多目标标量化（自适应权重或基于帕累托的分层奖励）。

### 4.3 训练与求解流程

1. **环境/仿真**：搭建包含焊接热输入-变形代理模型的仿真环境，支持工位/夹具可达性、切换时间、路径规划。
2. **高层预训练**：
   - 使用启发式（如约束启发的分群 + 关键点优先）生成可行解；
   - 通过模仿学习或行为克隆初始化 $\pi_H$，减少探索难度。
3. **低层训练**：在固定高层方案下，用连续动作算法（SAC/DDPG）最优控制焊接参数；可加入模型预测控制 (MPC) 或软约束惩罚保障安全。
4. **交替更新/协同优化**：
   - 采用分阶段训练：高层给出方案，低层优化后反馈性能指标；
   - 使用基于帕累托的多目标优化或自适应权重更新规则，更新高层奖励系数；
   - 可使用双层优化：外层高层策略梯度，内层低层策略/近似求解器；
   - 对几何精度/刚度等硬约束，引入约束策略优化（CPO、Lagrangian RL）。
5. **推理时协同**：
   - 高层在焊点图上生成分序和分配；
   - 低层基于实际设备状态在线调整参数（可用温度/功率的闭环补偿）。

### 4.4 关键技术要点

- **图结构建模**：焊点及前驱约束可建为有向图，使用 GNN 进行状态编码，便于高层策略泛化到不同车身和工位数量。
- **安全约束处理**：对热输入、几何偏差、刚度等硬约束采用屏障函数或拉格朗日乘子，在 RL 中加入约束成本；低层可结合 MPC 进行修正。
- **多目标权重自适应**：采用线性标量化且动态调整权重，如基于参考节拍/成本/精度目标的比例控制，或使用 multi-objective RL（比如 Pareto front policy distillation）。
- **混合求解与基线**：可将高层分配/排序转化为 MINLP 或 CP-SAT 求解得到基线，再用 RL 微调；或使用分枝定界 + 神经启发式求解器。

## 5. 数学模型小结

综上，问题可抽象为：
$$
\begin{aligned}
\min &\quad \lambda_1 \max_s C_s + \lambda_2 \text{Cost}(x,a,T,P,v) + \lambda_3 \text{Err}(a,T,P,v,r) \\
\text{s.t. } &\quad \sum_s a_{p,s}=1,\; a_{p,s}\in\{0,1\};\\
&\quad \text{前驱/可达性/夹具约束};\\
&\quad T^{\min}_p\le T_{p,s}\le T^{\max}_p,\; P^{\min}_p\le P_{p,s}\le P^{\max}_p;\\
&\quad H_{p,s}=\kappa P_{p,s}/v_{p,s} \le H^{\max}_p;\\
&\quad \|\Delta g\|_2 \le g^{\max},\; K_k \succeq K^{\min};\\
&\quad C_s \text{ 由路径/工步时间模型定义}. \\
\end{aligned}
$$
该模型具备混合整数与非线性特征，可通过分层强化学习结合混合求解策略实现求解与在线自适应。
